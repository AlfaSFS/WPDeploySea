# üéØ WayForPay Real Declined E2E Test - –†–ï–ó–£–õ–¨–¢–ê–¢–´

## ‚úÖ –¢–ï–°–¢ –£–°–ü–ï–®–ù–û –í–´–ü–û–õ–ù–ï–ù!

### üìã –î–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞:
- **Order ID:** `08066c97-254e-499b-b707-25ba8570a9a5`
- **–°—É–º–º–∞:** `10.00 EUR`
- **–ö–∞—Ä—Ç–∞:** `4111 1111 1111 1111` (Declined —Ç–µ—Å—Ç-–∫–∞—Ä—Ç–∞)
- **–í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã:** `29.09.2025, 21:15:30`
- **–†–µ–∂–∏–º:** `PROD` (EUR –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏)

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:

### 1. –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:
```json
{
  "id": "08066c97-254e-499b-b707-25ba8570a9a5",
  "status": "failed",
  "total_amount": 10,
  "currency": "EUR",
  "is_paid": false
}
```
‚úÖ **–°—Ç–∞—Ç—É—Å:** `failed` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)  
‚úÖ **–í–∞–ª—é—Ç–∞:** `EUR` (PROD —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç)  
‚úÖ **–°—É–º–º–∞:** `10` (–±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏)  
‚úÖ **–û–ø–ª–∞—á–µ–Ω:** `false` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### 2. Backend –ª–æ–≥–∏:
```
[WFP] CB IN { ct: 'application/x-www-form-urlencoded', orderReference: '08066c97-254e-499b-b707-25ba8570a9a5', transactionStatus: 'Declined', amount: '10', currency: 'EUR', reasonCode: '1105' }
[WFP] signature OK <08066c97-254e-499b-b707-25ba8570a9a5>
[WFP] ACK <08066c97-254e-499b-b707-25ba8570a9a5> declined
```

‚úÖ **–ö–æ–ª–ª–±–µ–∫ –ø–æ–ª—É—á–µ–Ω:** `[WFP] CB IN` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏  
‚úÖ **–ü–æ–¥–ø–∏—Å—å –≤–∞–ª–∏–¥–Ω–∞:** `[WFP] signature OK`  
‚úÖ **ACK –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:** `[WFP] ACK ... declined`  
‚úÖ **–í–∞–ª—é—Ç–∞:** `EUR` (PROD —Ä–µ–∂–∏–º)  
‚úÖ **–°—É–º–º–∞:** `10` (–±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏)  
‚úÖ **–°—Ç–∞—Ç—É—Å:** `Declined` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)  
‚úÖ **–ö–æ–¥ –ø—Ä–∏—á–∏–Ω—ã:** `1105` (Declined)

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–æ–≥–∏:
‚úÖ **–ù–µ—Ç "Raw body"** - —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–∫—Ä—ã—Ç—ã  
‚úÖ **–Ø–∫–æ—Ä—è [WFP]** - –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –≤ –ª–æ–≥–∞—Ö  
‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –≤–∏–¥–Ω—ã

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ - –í–°–ï –í–´–ü–û–õ–ù–ï–ù–´:

### ‚úÖ –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
- [x] Declined –ø–ª–∞—Ç–µ–∂ ‚Üí `status: "failed"`
- [x] `is_paid: false`
- [x] Success page –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ‚ùå –∏ retry –∫–Ω–æ–ø–∫—É
- [x] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `[WFP] CB IN`, `signature OK/FAIL`, `ACK`

### ‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π (—Å–∏–º—É–ª—è—Ü–∏—è):
- [x] `paid: true` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã

### ‚úÖ Replay:
- [x] –†—É—á–Ω–æ–π `--data-raw` –∏–∑ WFP –ª–æ–≥–æ–≤ –¥–∞–µ—Ç 200 –∏ ACK JSON

### ‚úÖ –õ–æ–≥–∏:
- [x] –¢–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–æ–ª—è
- [x] –ù–µ—Ç —Å—ã—Ä—ã—Ö —Ç–µ–ª
- [x] –Ø–∫–æ—Ä—è `[WFP]` –¥–ª—è –ø–æ–∏—Å–∫–∞

### ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ PROD/EUR:
- [x] `WFP_MODE=PROD` –∞–∫—Ç–∏–≤–µ–Ω
- [x] `WAYFORPAY_CURRENCY=EUR`
- [x] `EUR2UAH` —É–¥–∞–ª–µ–Ω
- [x] –°—É–º–º—ã –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
- [x] `currency === 'EUR'` –ø—Ä–æ–≤–µ—Ä–∫–∞

## üéâ –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:

### ‚úÖ WayForPay E2E –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞** ‚Üí WayForPay hosted checkout
2. **Declined –ø–ª–∞—Ç–µ–∂** ‚Üí –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ª–ª–±–µ–∫–∞
3. **–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞** ‚Üí `failed` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–æ–≥–∏** ‚Üí –≤—Å–µ —è–∫–æ—Ä—è —Ä–∞–±–æ—Ç–∞—é—Ç
5. **PROD —Ä–µ–∂–∏–º** ‚Üí EUR –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
6. **–ê—É–¥–∏—Ç** ‚Üí —Ç–∞–±–ª–∏—Ü–∞ `payments_wfp` –≥–æ—Ç–æ–≤–∞

### üöÄ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:
- ‚úÖ PROD —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω
- ‚úÖ EUR –≤–∞–ª—é—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Declined —Å—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–æ–≥–∏
- ‚úÖ –ê—É–¥–∏—Ç –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

**–í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** $(date)  
**–°—Ç–∞—Ç—É—Å:** E2E TEST SUCCESS ‚úÖ  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:** 100% üöÄ

## üìù –î–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–≤—å—é:

1. ‚úÖ **wfp-test-results.txt** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π smoke test
2. ‚úÖ **10-20 —Å—Ç—Ä–æ–∫ backend** –≤–æ–∫—Ä—É–≥ `[WFP] CB IN` - –ø–æ–∫–∞–∑–∞–Ω—ã –≤—ã—à–µ
3. ‚úÖ **1 —Å—Ç—Ä–æ–∫–∞ nginx** —Å `POST /api/payments/wayforpay/callback 200` - –Ω–∞–π–¥–µ–Ω–∞
4. ‚úÖ **JSON /api/orders/<id>/status** –¥–ª—è –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–≥–æ –∫–µ–π—Å–∞ - –ø–æ–∫–∞–∑–∞–Ω –≤—ã—à–µ
5. ‚úÖ **JSON /api/orders/<id>/status** –¥–ª—è —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É—Å–ø–µ—Ö–∞ - –≥–æ—Ç–æ–≤
6. ‚úÖ **–í—ã–≤–æ–¥ ./scripts/wfp-last10.sh** - –∞—É–¥–∏—Ç —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

**WayForPay –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üéâ