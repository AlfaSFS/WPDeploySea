# üéØ WayForPay Integration - –ü–õ–ê–ù –í–´–ü–û–õ–ù–ï–ù

## ‚úÖ 1. –ó–∞–∫—Ä—ã—Ç–∏–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–≥–æ E2E —Ç–µ—Å—Ç–∞

### –ì–æ—Ç–æ–≤—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:

-  **–ó–∞–∫–∞–∑ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** `e25f2d7c-d504-45a6-925a-8289bd59b6e5`
-  **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** `wfp-manual-execution-guide.md`
-  **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:** `scripts/wfp-monitor-logs.sh`

### –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:

–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂ —Å —Ç–µ—Å—Ç-–∫–∞—Ä—Ç–æ–π `4111 1111 1111 1111` –∏ —Å–æ–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

## ‚úÖ 2. –°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Å–ø–µ—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```json
{
   "success": true,
   "message": "Payment simulated successfully",
   "orderId": "e25f2d7c-d504-45a6-925a-8289bd59b6e5",
   "status": "paid"
}
```

**–°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ —Å–∏–º—É–ª—è—Ü–∏–∏:**

```json
{
   "id": "e25f2d7c-d504-45a6-925a-8289bd59b6e5",
   "status": "paid",
   "total_amount": 1,
   "currency": "EUR",
   "is_paid": true
}
```

## ‚úÖ 3. –§–ª–∞–∂–æ–∫ —Ä–µ–∂–∏–º–∞ WFP_MODE —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

### –ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

-  **WFP_MODE=TEST** (—Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º)
-  **WFP_MODE=PROD** (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
-  **prepareAmounts()** —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
-  **IS_TEST** —Ñ–ª–∞–≥ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏

### –ü—Ä–∏–º–µ—Ä—ã .env —Ñ–∞–π–ª–æ–≤:

-  **env.test.example** - —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (UAH, EUR2UAH=40)
-  **env.production.example** - –ø—Ä–æ–¥–∞–∫—à–µ–Ω (EUR, –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WFP_MODE:

```json
{
   "currency": "UAH",
   "amount": "40.00",
   "productPrice": ["40.00"]
}
```

‚úÖ **1.00 EUR ‚Üí 40.00 UAH** (rate=40)

## ‚úÖ 4. "–¢–∏—Ö–∏–µ" —É–ª—É—á—à–µ–Ω–∏—è

### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–æ–≥–∏:

-  ‚ùå –£–±—Ä–∞–Ω–æ: "Raw body"
-  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: `[WFP] CB IN { ... }`
-  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: `[WFP] signature OK/FAIL <orderReference>`
-  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: `[WFP] ACK <orderReference> approved|declined`

### –ê—É–¥–∏—Ç –≤ –ë–î:

-  ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è:** `backend/data/migrations/2025-09-29-wfp_audit.sql`
-  ‚úÖ **–¢–∞–±–ª–∏—Ü–∞:** `payments_wfp` —Å–æ–∑–¥–∞–Ω–∞
-  ‚úÖ **–°–∫—Ä–∏–ø—Ç:** `scripts/wfp-last10.sh` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

### Pending timeout:

-  ‚úÖ **–°–∫—Ä–∏–ø—Ç:** `scripts/wfp-timeout-cleanup.sh`
-  ‚ö†Ô∏è **Endpoint:** `/api/orders/timeout-cleanup` —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Frontend UX:

-  ‚úÖ **ReturnUrl:** —Å `?order=...` —Ä–∞–±–æ—Ç–∞–µ—Ç
-  ‚úÖ **–ü—É–ª–ª–ª–∏–Ω–≥:** —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ `/payment-success`
-  ‚úÖ **–ö–Ω–æ–ø–∫–∞:** "–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑" —Ä–∞–±–æ—Ç–∞–µ—Ç

## ‚ö†Ô∏è 5. Telegram —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:

-  **TELEGRAM_CHAT_ID:** —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (404 –æ—à–∏–±–∫–∞)
-  **sendMessage:** –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –ù–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É/–≤ –≥—Ä—É–ø–ø—É
2. –ü–æ–ª—É—á–∏—Ç—å `chat_id` —á–µ—Ä–µ–∑ `getUpdates`
3. –û–±–Ω–æ–≤–∏—Ç—å `TELEGRAM_CHAT_ID`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å `sendMessage`

## üìä –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

-  [x] WFP_MODE –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å (TEST/PROD)
-  [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è EUR‚ÜîUAH
-  [x] –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–æ–≥–∏ —Å —è–∫–æ—Ä—è–º–∏
-  [x] –ê—É–¥–∏—Ç-—Ç–∞–±–ª–∏—Ü–∞ payments_wfp
-  [x] –°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Å–ø–µ—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç
-  [x] Frontend UX –≥–æ—Ç–æ–≤
-  [x] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

-  [ ] **–†–µ–∞–ª—å–Ω—ã–π Declined —Ç–µ—Å—Ç** —Å –∫–∞—Ä—Ç–æ–π `4111 1111 1111 1111`
-  [ ] **Telegram chat_id** –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
-  [ ] **Timeout cleanup** endpoint —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### üéØ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:

-  [x] –ö–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WFP_MODE=PROD
-  [x] EUR –≤–∞–ª—é—Ç–∞ –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
-  [x] –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–æ–≥–∏
-  [x] –ê—É–¥–∏—Ç –ø–ª–∞—Ç–µ–∂–µ–π

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** $(date)  
**–°—Ç–∞—Ç—É—Å:** –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ 90%  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –†—É—á–Ω–æ–π Declined —Ç–µ—Å—Ç + Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
